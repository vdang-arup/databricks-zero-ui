import{G as R,K as U,L as f,S as y,Ya as p,g as m,i as A,k as d,l as h,lb as N,m as k,mb as l,n as I,nb as S,r as w,s as C,w as v}from"./chunk-QGX4UOGU.js";import{i as a}from"./chunk-DNA43DVC.js";function b(u){return u.status!==void 0}var c={UserInteractionRequired:"USER_INTERACTION_REQUIRED",UserCancel:"USER_CANCEL",NoNetwork:"NO_NETWORK",TransientError:"TRANSIENT_ERROR",PersistentError:"PERSISTENT_ERROR",Disabled:"DISABLED",AccountUnavailable:"ACCOUNT_UNAVAILABLE",NestedAppAuthUnavailable:"NESTED_APP_AUTH_UNAVAILABLE"};var E=class{constructor(e,t,n,o){this.clientId=e,this.clientCapabilities=t,this.crypto=n,this.logger=o}toNaaTokenRequest(e){let t;e.extraQueryParameters===void 0?t=new Map:t=new Map(Object.entries(e.extraQueryParameters));let o=new U().addClientCapabilitiesToClaims(e.claims,this.clientCapabilities);return{platformBrokerId:e.account?.homeAccountId,clientId:this.clientId,authority:e.authority,scope:e.scopes.join(" "),correlationId:e.correlationId!==void 0?e.correlationId:this.crypto.createNewGuid(),claims:v.isEmptyObj(o)?void 0:o,state:e.state,authenticationScheme:e.authenticationScheme||m.BEARER,extraParameters:t}}fromNaaTokenResponse(e,t,n){if(!t.token.id_token||!t.token.access_token)throw k(d.nullOrEmptyToken);let o=new Date((n+(t.token.expires_in||0))*1e3),i=w.extractTokenClaims(t.token.id_token,this.crypto.base64Decode),s=this.fromNaaAccountInfo(t.account,i),g=t.token.scope||e.scope;return{authority:t.token.authority||s.environment,uniqueId:s.localAccountId,tenantId:s.tenantId,scopes:g.split(" "),account:s,idToken:t.token.id_token,idTokenClaims:i,accessToken:t.token.access_token,fromCache:!0,expiresOn:o,tokenType:e.authenticationScheme||m.BEARER,correlationId:e.correlationId,extExpiresOn:o,state:e.state}}fromNaaAccountInfo(e,t){let n=t||e.idTokenClaims,o=e.localAccountId||n?.oid||n?.sub||"",i=e.tenantId||n?.tid||"",s=e.homeAccountId||`${o}.${i}`,g=e.username||n?.preferred_username||"",T=e.name||n?.name;return{homeAccountId:s,environment:e.environment,tenantId:i,username:g,localAccountId:o,name:T,idToken:e.idToken,idTokenClaims:n}}fromBridgeError(e){if(b(e))switch(e.status){case c.UserCancel:return new h(d.userCanceled);case c.NoNetwork:return new h(d.noNetworkConnectivity);case c.AccountUnavailable:return new h(d.noAccountFound);case c.Disabled:return new h(d.nestedAppAuthBridgeDisabled);case c.NestedAppAuthUnavailable:return new h(e.code||d.nestedAppAuthBridgeDisabled,e.description);case c.TransientError:case c.PersistentError:return new R(e.code,e.description);case c.UserInteractionRequired:return new y(e.code,e.description);default:return new A(e.code,e.description)}else return new A("unknown_error","An unknown error occurred")}};var P={unsupportedMethod:{code:"unsupported_method",desc:"The PKCE code challenge and verifier could not be generated."}},r=class u extends A{constructor(e,t){super(e,t),Object.setPrototypeOf(this,u.prototype),this.name="NestedAppAuthError"}static createUnsupportedError(){return new u(P.unsupportedMethod.code,P.unsupportedMethod.desc)}};var x=class u{constructor(e){this.operatingContext=e;let t=this.operatingContext.getBridgeProxy();if(t!==void 0)this.bridgeProxy=t;else throw new Error("unexpected: bridgeProxy is undefined");this.config=e.getConfig(),this.logger=this.operatingContext.getLogger(),this.performanceClient=this.config.telemetry.client,this.browserCrypto=e.isBrowserEnvironment()?new N(this.logger,this.performanceClient):I,this.eventHandler=new S(this.logger,this.browserCrypto),this.nestedAppAuthAdapter=new E(this.config.auth.clientId,this.config.auth.clientCapabilities,this.browserCrypto,this.logger)}getBrowserStorage(){throw r.createUnsupportedError()}getEventHandler(){return this.eventHandler}static createController(e){return a(this,null,function*(){let t=new u(e);return Promise.resolve(t)})}initialize(){return Promise.resolve()}acquireTokenInteractive(e){return a(this,null,function*(){this.eventHandler.emitEvent(l.ACQUIRE_TOKEN_START,p.Popup,e);let t=this.performanceClient.startMeasurement(f.AcquireTokenPopup,e.correlationId);t?.add({nestedAppAuthRequest:!0});try{let n=this.nestedAppAuthAdapter.toNaaTokenRequest(e),o=C.nowSeconds(),i=yield this.bridgeProxy.getTokenInteractive(n),s=this.nestedAppAuthAdapter.fromNaaTokenResponse(n,i,o);return this.operatingContext.setActiveAccount(s.account),this.eventHandler.emitEvent(l.ACQUIRE_TOKEN_SUCCESS,p.Popup,s),t.add({accessTokenSize:s.accessToken.length,idTokenSize:s.idToken.length}),t.end({success:!0,requestId:s.requestId}),s}catch(n){let o=this.nestedAppAuthAdapter.fromBridgeError(n);throw this.eventHandler.emitEvent(l.ACQUIRE_TOKEN_FAILURE,p.Popup,null,n),t.end({errorCode:o.errorCode,subErrorCode:o.subError,success:!1}),o}})}acquireTokenSilentInternal(e){return a(this,null,function*(){this.eventHandler.emitEvent(l.ACQUIRE_TOKEN_START,p.Silent,e);let t=this.performanceClient.startMeasurement(f.SsoSilent,e.correlationId);t?.increment({visibilityChangeCount:0}),t?.add({nestedAppAuthRequest:!0});try{let n=this.nestedAppAuthAdapter.toNaaTokenRequest(e),o=C.nowSeconds(),i=yield this.bridgeProxy.getTokenSilent(n),s=this.nestedAppAuthAdapter.fromNaaTokenResponse(n,i,o);return this.operatingContext.setActiveAccount(s.account),this.eventHandler.emitEvent(l.ACQUIRE_TOKEN_SUCCESS,p.Silent,s),t?.add({accessTokenSize:s.accessToken.length,idTokenSize:s.idToken.length}),t?.end({success:!0,requestId:s.requestId}),s}catch(n){let o=this.nestedAppAuthAdapter.fromBridgeError(n);throw this.eventHandler.emitEvent(l.ACQUIRE_TOKEN_FAILURE,p.Silent,null,n),t?.end({errorCode:o.errorCode,subErrorCode:o.subError,success:!1}),o}})}acquireTokenPopup(e){return a(this,null,function*(){return this.acquireTokenInteractive(e)})}acquireTokenRedirect(e){throw r.createUnsupportedError()}acquireTokenSilent(e){return a(this,null,function*(){return this.acquireTokenSilentInternal(e)})}acquireTokenByCode(e){throw r.createUnsupportedError()}acquireTokenNative(e,t,n){throw r.createUnsupportedError()}acquireTokenByRefreshToken(e,t){throw r.createUnsupportedError()}addEventCallback(e){return this.eventHandler.addEventCallback(e)}removeEventCallback(e){this.eventHandler.removeEventCallback(e)}addPerformanceCallback(e){throw r.createUnsupportedError()}removePerformanceCallback(e){throw r.createUnsupportedError()}enableAccountStorageEvents(){throw r.createUnsupportedError()}disableAccountStorageEvents(){throw r.createUnsupportedError()}getAccount(e){throw r.createUnsupportedError()}getAccountByHomeId(e){let t=this.operatingContext.getActiveAccount();return t!==void 0&&t.homeAccountId===e?this.nestedAppAuthAdapter.fromNaaAccountInfo(t):null}getAccountByLocalId(e){let t=this.operatingContext.getActiveAccount();return t!==void 0&&t.localAccountId===e?this.nestedAppAuthAdapter.fromNaaAccountInfo(t):null}getAccountByUsername(e){let t=this.operatingContext.getActiveAccount();return t!==void 0&&t.username===e?this.nestedAppAuthAdapter.fromNaaAccountInfo(t):null}getAllAccounts(){let e=this.operatingContext.getActiveAccount();return e!==void 0?[this.nestedAppAuthAdapter.fromNaaAccountInfo(e)]:[]}handleRedirectPromise(e){throw r.createUnsupportedError()}loginPopup(e){if(e!==void 0)return this.acquireTokenInteractive(e);throw r.createUnsupportedError()}loginRedirect(e){throw r.createUnsupportedError()}logout(e){throw r.createUnsupportedError()}logoutRedirect(e){throw r.createUnsupportedError()}logoutPopup(e){throw r.createUnsupportedError()}ssoSilent(e){return this.acquireTokenSilentInternal(e)}getTokenCache(){throw r.createUnsupportedError()}getLogger(){return this.logger}setLogger(e){this.logger=e}setActiveAccount(e){this.logger.warning("nestedAppAuth does not support setActiveAccount")}getActiveAccount(){let e=this.operatingContext.getActiveAccount();return e!==void 0?this.nestedAppAuthAdapter.fromNaaAccountInfo(e):null}initializeWrapperLibrary(e,t){}setNavigationClient(e){this.logger.warning("setNavigationClient is not supported in nested app auth")}getConfiguration(){return this.config}isBrowserEnv(){return this.operatingContext.isBrowserEnvironment()}getBrowserCrypto(){return this.browserCrypto}getPerformanceClient(){throw r.createUnsupportedError()}getRedirectResponse(){throw r.createUnsupportedError()}preflightBrowserEnvironmentCheck(e,t){throw r.createUnsupportedError()}clearCache(e){return a(this,null,function*(){throw r.createUnsupportedError()})}hydrateCache(e,t){return a(this,null,function*(){throw r.createUnsupportedError()})}};export{x as NestedAppAuthController};
